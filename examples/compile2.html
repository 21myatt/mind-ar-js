<html>
  <head>
    <script src="https://www.lactame.com/lib/image-js/0.21.2/image.min.js"></script> 
    <script src="https://rawgit.com/kawanet/msgpack-lite/master/dist/msgpack.min.js"></script>
    <script src="../dist/mindar.js"></script>

    <script>
      const getGreyImage = (image) => {
        const _greyImage = image.grey({algorithm: "average"});
        const greyImage = {
          width: _greyImage.width,
          height: _greyImage.height,
          data: []
        };
        for (let i = 0; i < _greyImage.data.length; i++) {
          greyImage.data.push( Math.floor(_greyImage.data[i] / _greyImage.maxValue * 255));
        }
        return greyImage;
      }

      const showImage = (targetImage, points) => {
        const container = document.getElementById("container");
        const canvas = document.createElement('canvas');
        container.appendChild(canvas);
        canvas.width  = targetImage.width;
        canvas.height = targetImage.height;
        canvas.style.width = canvas.width;
        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = new Uint32Array(imageData.data.buffer);

        const alpha = (0xff << 24);
        for (let c = 0; c < targetImage.width; c++) {
          for (let r = 0; r < targetImage.height; r++) {
            const pix = targetImage.data[r * targetImage.width + c];
            data[r * canvas.width + c] = alpha | (pix << 16) | (pix << 8) | pix;
          }
        }

        var pix = (0xff << 24) | (0x00 << 16) | (0xff << 8) | 0x00; // green
        for (let i=0; i < points.length; ++i) {
          const x = points[i].x;
          const y = points[i].y;
          const offset = (x + y * canvas.width);
          data[offset] = pix;
          for (var size = 1; size <= 3; size++) {
            data[offset-size] = pix;
            data[offset+size] = pix;
            data[offset-size*canvas.width] = pix;
            data[offset+size*canvas.width] = pix;
          }
        }
        ctx.putImageData(imageData, 0, 0);
      }

      document.addEventListener('DOMContentLoaded', function(event) {
        async function process() {
          const filename = 'card1';

          let targetImage = await IJS.Image.load('./assets/' + filename + '.png');
          //targetImage = targetImage.resize({width: 337, height: 186});
          //targetImage = targetImage.resize({width: targetImage.width/2, height: targetImage.height/2});
          //document.getElementById('target-image').src = targetImage.toDataURL();
          const greyTargetImage = getGreyImage(targetImage);

          var _start = new Date().getTime();
          var data = MINDAR.Utils.compileImageTarget(greyTargetImage);
          var _end = new Date().getTime();
          console.log('exec time compile Image: ', _start, _end, _end - _start);

          console.log("compiled data", data);

          for (let i = 0; i < data.imageList.length; i++) {
            const image = data.imageList[i];
            const coords = data.trackingData.featureSets[i].coords;
            const kpmPoints = data.matchingData.keyframes[i].points;
            const points = [];
            for (let j = 0; j < coords.length; j++) {
              points.push({x: coords[j].mx * image.dpi, y: image.height - coords[j].my * image.dpi});
            }
            showImage(image, points);

            const points2 = [];
            for (let j = 0; j < kpmPoints.length; j++) {
              points2.push({x: Math.round(kpmPoints[j].x2D), y: Math.round(kpmPoints[j].y2D)});
            }
            //showImage(image, points2);
          }

          //return;

          var buffer = msgpack.encode(data);
          var blob = new Blob([buffer], {type: 'text/plain'});
          var aLink = window.document.createElement('a');
          aLink.download = 'new' + filename + '.msp';
          aLink.href = window.URL.createObjectURL(blob);
          aLink.click();
          window.URL.revokeObjectURL(aLink.href);
        }
        process();
      });
    </script>

    <style>
      #container {
        display: flex;
        flex-direction: column;
      }
    </style>
  </head>
  <body>
    <div id="container">
    </div>
  </body>
</html>
