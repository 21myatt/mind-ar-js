<html>
  <head>
    <script src="https://www.lactame.com/lib/image-js/0.21.2/image.min.js"></script> 
    <script src="https://rawgit.com/kawanet/msgpack-lite/master/dist/msgpack.min.js"></script>
    <script src="../dist/mindar.js"></script>
    <script>

      const getGreyImage = (image) => {
        const greyImage = {
          width: image.width,
          height: image.height,
          data: []
        }
        for (let i = 0; i < image.data.length; i+=4) {
          greyImage.data.push( Math.floor((image.data[i] + image.data[i+1] + image.data[i+2]) / 3));
        }
        return greyImage;
      }

      document.addEventListener('DOMContentLoaded', function(event) {
        async function process() {
          /*
          fetch('./assets/data.buf')
            .then(response => response.arrayBuffer())
            .then(buffer => {
              var d = msgpack.decode(new Uint8Array(buffer));
              console.log("d", d);
            });
          */


          let targetImage = await IJS.Image.load('./assets/card.png');
          document.getElementById('target-image').src = targetImage.toDataURL();
          const greyTargetImage = getGreyImage(targetImage);

          var _start = new Date().getTime();
          var data = MINDAR.Utils.compileImageTarget(greyTargetImage);
          var _end = new Date().getTime();
          console.log('exec time compile Image: ', _start, _end, _end - _start);

          var buffer = msgpack.encode(data);
          console.log("buf", buffer);
          var blob = new Blob([buffer], {type: 'text/plain'});
          var aLink = window.document.createElement('a');
          aLink.download = 'card.msp';
          aLink.href = window.URL.createObjectURL(blob);
          aLink.click();
          window.URL.revokeObjectURL(aLink.href);
        }
        process();
      });
    </script>
  </head>
  <body>
    <img id="target-image"/>
  </body>
</html>

