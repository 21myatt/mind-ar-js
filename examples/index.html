<html>
  <head>
    <script src="https://www.lactame.com/lib/image-js/0.21.2/image.min.js"></script> 
    <script src="https://rawgit.com/kawanet/msgpack-lite/master/dist/msgpack.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gpu.js@latest/dist/gpu-browser.min.js"></script>
    <script src="../dist/mindar.js"></script>
    <script>
      window.DEBUG_MATCH = true;
      window.DEBUG_TIME = true;
      window.DEBUG_MATCH = false;
      window.DEBUG_TRACK = true;
      window.DEBUG_TRACK = false;
      window.debug = {};

      var _start;
      var _last;
      _start = new Date().getTime();
      _last = new Date().getTime();
      const logTime = (title) => {
        console.log(title + ': ' + (new Date().getTime() - _last).toString().padStart(3, '0') + ".");
        _last = new Date().getTime();
      }

      const EPSILON = 0.0001;
      const cmp = (a, b, ep) => {
        if (ep) return Math.abs(a-b) < ep;
        if (a === 0 && b === 0) return true;
        return Math.abs(a-b) / Math.abs(a) < 0.01; // 1% error
        //return Math.abs(a-b) < (ep? ep: EPSILON)
      };
      const cmpObj = (a, b, keys) => {
        if (!!a !== !!b) return false;
        for (let i = 0; i < keys.length; i++) {
          const key = keys[i];
          if (!cmp(a[key], b[key])) {
            console.log("cmp obj false", key);
            return false;
          }
        }
        return true;
      };
      const cmp2DArray = (a, b, ep) => {
        if (!!a !== !!b) return false;
        if (!!a) {
          if (a.length !== b.length) return false;
          for (let i = 0; i < a.length; i++) {
            if (a[i] === null && b[i] === null) continue;
            if (!cmpArray(a[i], b[i], ep)) return false;
          }
        }
        return true;
      };
      const cmpArray = (a, b, ep) => {
        if (!!a !== !!b) return false;
        if (!!a) {
          if (a.length !== b.length) return false;
          for (let i = 0; i < a.length; i++) {
            if (a[i] === null && b[i] === null) continue;
            if (!cmp(a[i], b[i], ep)) {
              console.log("cmp array false", i);
              return false;
            }
          }
        }
        return true;
      }
      window.cmp = cmp;
      window.cmpObj = cmpObj;
      window.cmpArray = cmpArray;
      window.cmp2DArray = cmp2DArray;

      const getGreyImage = (image) => {
        const _greyImage = image.grey({algorithm: "average"});
        const greyImage = {
          width: _greyImage.width,
          height: _greyImage.height,
          data: new Uint8Array(_greyImage.width * _greyImage.height)
        };
        for (let i = 0; i < _greyImage.data.length; i++) {
          greyImage.data[i] = Math.floor(_greyImage.data[i] / _greyImage.maxValue * 255);
          //for (let j = 0; j < 100; j++) {
          //  greyImage.data[i] += j;
          //}
        }
        return greyImage;
      }

      //const pw = 320;
      //const ph = 240;
      const pw = 640;
      const ph = 480;
      //const pw = 800;
      //const ph = 1001;

      document.addEventListener('DOMContentLoaded', function(event) {
        async function process() {
          //const queryfilename = 'card7_3';
          const queryfilename = 'card7_3';
          const queryfilename2 = 'card7_2';
          const queryfilename3 = 'card1_2';
          const msp = await fetch('./assets/debugMatch_' + queryfilename + '_' + ph + '_p1.msp');
          const msp2 = await fetch('./assets/debugMatch_' + queryfilename + '_' + ph + '_p2.msp');
          const msp3 = await fetch('./assets/debugMatch_' + queryfilename + '_' + ph + '_p3.msp');
          const msp4 = await fetch('./assets/debugMatch_' + queryfilename + '_' + ph + '_p4.msp');
          const msp5 = await fetch('./assets/debugMatch_' + queryfilename + '_' + ph + '_p5.msp');
          const debugMatch = msgpack.decode(new Uint8Array(await msp.arrayBuffer()));
          const debugMatch2 = msgpack.decode(new Uint8Array(await msp2.arrayBuffer()));
          const debugMatch3 = msgpack.decode(new Uint8Array(await msp3.arrayBuffer()));
          const debugMatch4 = msgpack.decode(new Uint8Array(await msp4.arrayBuffer()));
          const debugMatch5 = msgpack.decode(new Uint8Array(await msp5.arrayBuffer()));
          window.allDebugMatches = [debugMatch, debugMatch2, debugMatch3, debugMatch4, debugMatch5];
          window.debugMatch = debugMatch;

          const filename = 'card7';
          const compiledMSP = await fetch('./assets/new' + filename + '.msp');
          const compiled = msgpack.decode(new Uint8Array(await compiledMSP.arrayBuffer()));

          console.log("create controller");
          //var controller = new MINDAR.Controller({useworker: true});
          var controller = new MINDAR.Controller({useworker: false});
          console.log("controller", controller);
          await controller.setup({inputWidth: pw, inputHeight: ph});
          console.log("controller setup");

          const proj = controller.getProjectionMatrix();
          console.log("proj", proj);

          await controller.addImageTarget({type: 'compiled', input: compiled});

          let queryImage = await IJS.Image.load('./assets/' + queryfilename + '.png');
          queryImage = queryImage.resize({width: pw, height: ph});
          document.getElementById('query-image').src = queryImage.toDataURL();
          let queryImageEle = document.getElementById('query-image');
          queryImageEle.width = pw;
          queryImageEle.height = ph;

          let queryImage2 = await IJS.Image.load('./assets/' + queryfilename2 + '.png');
          queryImage2 = queryImage2.resize({width: pw, height: ph});
          document.getElementById('query-image2').src = queryImage2.toDataURL();
          let queryImageEle2 = document.getElementById('query-image2');
          queryImageEle2.width = pw;
          queryImageEle2.height = ph;

          let queryImage3 = await IJS.Image.load('./assets/' + queryfilename3 + '.png');
          queryImage3 = queryImage3.resize({width: pw, height: ph});
          document.getElementById('query-image3').src = queryImage3.toDataURL();
          let queryImageEle3 = document.getElementById('query-image2');
          queryImageEle3.width = pw;
          queryImageEle3.height = ph;

          var __start = new Date().getTime();
          const greyQueryImage = getGreyImage(queryImage);
          console.log('exec time grey CPU: ', new Date().getTime() - __start);

          const greyQueryImage2 = getGreyImage(queryImage2);

          var _start = new Date().getTime();
          const res = await controller.process(queryImageEle);
          console.log("process res", res[0].worldMatrix);
          var _end = new Date().getTime();
          console.log('exec time process 1: ', _start, _end, _end - _start);

          var _start = new Date().getTime();
          console.log("2 AR PROCESS....");
          const res2 = await controller.process(queryImageEle2);
          console.log("process res2", res2[0].worldMatrix);
          var _end = new Date().getTime();
          console.log('exec time process 2: ', _start, _end, _end - _start);

          var _start = new Date().getTime();
          console.log("3 AR PROCESS....");
          const res3 = await controller.process(queryImageEle);
          console.log("process res", res3[0].worldMatrix);
          var _end = new Date().getTime();
          console.log('exec time process 3: ', _start, _end, _end - _start);

          var _start = new Date().getTime();
          console.log("4 AR PROCESS....");
          const res4 = await controller.process(queryImageEle);
          console.log("process res", res4[0].worldMatrix);
          var _end = new Date().getTime();
          console.log('exec time process 4: ', _start, _end, _end - _start);

          var _start = new Date().getTime();
          console.log("5 AR PROCESS....");
          const res5 = await controller.process(queryImageEle2);
          console.log("process res", res5[0].worldMatrix);
          var _end = new Date().getTime();
          console.log('exec time process 5: ', _start, _end, _end - _start);

          var _start = new Date().getTime();
          console.log("6 AR PROCESS....");
          const res6 = await controller.process(queryImageEle2);
          console.log("process res", res6[0].worldMatrix);
          var _end = new Date().getTime();
          console.log('exec time process 6: ', _start, _end, _end - _start);
          return;

          console.log("feature set count", featureSets.length, 'vs', debugContent.featureSets.length);
          for (let i = 0; i < featureSets.length; i++) {
            const f1 = featureSets[i];
            const f2 = debugContent.featureSets[i];
            if (!cmpObj(f1, f2, ['maxdpi', 'mindpi', 'scale'])) {
              console.log("INCORRECT featureset", f1, f2);
            }
            console.log("coords count", f1.coords.length, f2.coords.length);
            for (let j = 0; j < f1.coords.length; j++) {
              if (!cmpObj(f1.coords[j], f2.coords[j], ['x', 'y', 'mx', 'my', 'maxSim'])) {
                console.log("INCORRECT featureset coord", f1.coords[j], f2.coords[j]);
              }
              //console.log("featureset coord", f1.coords[j], f2.coords[j]);
            }
          }

          return;
          var _start = new Date().getTime();
          var controller = new MINDAR.Controller(pw, ph);
          //controller.addImageTarget({type: 'image', input: greyTargetImage});
          controller.addImageTarget({type: 'compiled', input: compiled});
          var _end = new Date().getTime();
          console.log('exec time compile Image: ', _start, _end, _end - _start);


          const ele = document.getElementById("test-image2");
          const canvas_process = document.getElementById('canvas');
          canvas_process.width = pw;
          canvas_process.height = ph;
          const context_process = canvas_process.getContext('2d');
          var w = ele.width;
          var h = ele.height;
          console.log("draw", w, h, pw, ph);
          context_process.drawImage(ele, 0, 0, w, h, 0, 0, pw, ph);
          var imageData = context_process.getImageData(0, 0, pw, ph);
          var greyImageData = [];
          for (let i = 0; i < imageData.data.length; i+=4) {
            greyImageData.push( Math.floor((imageData.data[i] + imageData.data[i+1] + imageData.data[i+2]) / 3));
          }

          console.log("data length: ", imageData.data.length, queryImage.data.length, greyImageData.length, greyQueryImage.data.length);
          for (let i = 0; i < imageData.data.length; i++) {
            if (imageData.data[i] != queryImage.data[i]) {
              console.log("INCORRECT color", i, imageData.data[i], queryImage.data[i]);
              break;
            }
          }
          for (let i = 0; i < greyImageData.length; i++) {
            if (greyImageData[i] !== greyQueryImage.data[i]) {
              console.log("INCORRECT grey", i, greyImageData[i], greyQueryImage.data[i]);
              break;
            }
          }

          var _start = new Date().getTime();
          //controller.process(queryImage);
          const result = controller.process({data: greyImageData, width: pw, height: ph});
          //const result = controller.process(greyQueryImage);
          console.log("result: ", result);
          var _end = new Date().getTime();
          console.log('exec time process Image: ', _start, _end, _end - _start);
        }
        process();
      });

      const showImage = (targetImage, points) => {
        const container = document.getElementById("container");
        const canvas = document.createElement('canvas');
        container.appendChild(canvas);
        canvas.width  = targetImage.width;
        canvas.height = targetImage.height;
        canvas.style.width = canvas.width;
        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = new Uint32Array(imageData.data.buffer);

        const alpha = (0xff << 24);
        for (let c = 0; c < targetImage.width; c++) {
          for (let r = 0; r < targetImage.height; r++) {
            const pix = targetImage.data[r * targetImage.width + c];
            data[r * canvas.width + c] = alpha | (pix << 16) | (pix << 8) | pix;
          }
        }

        var pix = (0xff << 24) | (0x00 << 16) | (0xff << 8) | 0x00; // green
        for (let i=0; i < points.length; ++i) {
          const x = points[i].x;
          const y = points[i].y;
          const offset = (x + y * canvas.width);
          data[offset] = pix;
          for (var size = 1; size <= 3; size++) {
            data[offset-size] = pix;
            data[offset+size] = pix;
            data[offset-size*canvas.width] = pix;
            data[offset+size*canvas.width] = pix;
          }
        }
        ctx.putImageData(imageData, 0, 0);
      }
    </script>
  </head>
  <body>
    <img id="query-image"/>
    <img id="query-image2"/>
    <img id="query-image3"/>
    <div id="container">
    </div>
  </body>
</html>
