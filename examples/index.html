<html>
  <head>
    <script src="https://www.lactame.com/lib/image-js/0.21.2/image.min.js"></script> 
    <script src="https://rawgit.com/kawanet/msgpack-lite/master/dist/msgpack.min.js"></script>
    <script src="../dist/mindar.js"></script>
    <script>
      const EPSILON = 0.0001;
      const cmp = (a, b) => {return Math.abs(a-b) < EPSILON};
      const cmpObj = (a, b, keys) => {
        for (let i = 0; i < keys.length; i++) {
          const key = keys[i];
          if (!cmp(a[key], b[key])) return false;
        }
        return true;
      };

      const _getGreyImage = (image) => {
        const greyImage = {
          width: image.width,
          height: image.height,
          data: []
        }
        for (let i = 0; i < image.data.length; i+=4) {
          greyImage.data.push( Math.floor((image.data[i] + image.data[i+1] + image.data[i+2]) / 3));
        }
        return greyImage;
      }

      const getGreyImage = (image) => {
        const _greyImage = image.grey({algorithm: "average"});
        console.log("_grey", _greyImage);

        const greyImage = {
          width: _greyImage.width,
          height: _greyImage.height,
          data: []
        };
        for (let i = 0; i < _greyImage.data.length; i++) {
          greyImage.data.push( Math.floor(_greyImage.data[i] / _greyImage.maxValue * 255));
        }
        return greyImage;
      }

      document.addEventListener('DOMContentLoaded', function(event) {
        async function process() {
          const filename = 'card3';
          const f = await fetch('./assets/debugGen_' + filename + '.txt');
          const debugContent = JSON.parse(await f.text());
          console.log("d", debugContent);

          //const pw = 640;
          //const ph = 480;
          const pw = 320;
          const ph = 240;

          let targetImage = await IJS.Image.load('./assets/card.png');
          let queryImage = await IJS.Image.load('./assets/test.png');
          queryImage.resize({width: pw, height: ph});

          //document.getElementById('target-image').src = targetImage.toDataURL();
          document.getElementById('test-image').src = queryImage.toDataURL();

          //const greyTargetImage = getGreyImage(targetImage);
          const greyQueryImage = getGreyImage(queryImage);

          const msp = await fetch('./assets/' + filename + '.msp');
          const buffer = await msp.arrayBuffer();
          const compiled = msgpack.decode(new Uint8Array(buffer));
          const featureSets = compiled.trackingData.featureSets;

          console.log("compiled", compiled);
          console.log("feature set count", featureSets.length, 'vs', debugContent.featureSets.length);
          for (let i = 0; i < featureSets.length; i++) {
            const f1 = featureSets[i];
            const f2 = debugContent.featureSets[i];
            if (!cmpObj(f1, f2, ['maxdpi', 'mindpi', 'scale'])) {
              console.log("INCORRECT featureset", f1, f2);
            }
            console.log("coords count", f1.coords.length, f2.coords.length);
            for (let j = 0; j < f1.coords.length; j++) {
              if (!cmpObj(f1.coords[j], f2.coords[j], ['x', 'y', 'mx', 'my', 'maxSim'])) {
                console.log("INCORRECT featureset coord", f1.coords[j], f2.coords[j]);
              }
              //console.log("featureset coord", f1.coords[j], f2.coords[j]);
            }
          }

          return;
          var _start = new Date().getTime();
          var controller = new MINDAR.Controller(pw, ph);
          //controller.addImageTarget({type: 'image', input: greyTargetImage});
          controller.addImageTarget({type: 'compiled', input: compiled});
          var _end = new Date().getTime();
          console.log('exec time compile Image: ', _start, _end, _end - _start);

          const proj = controller.getProjectionMatrix();
          console.log("proj", proj);

          const ele = document.getElementById("test-image2");
          const canvas_process = document.getElementById('canvas');
          canvas_process.width = pw;
          canvas_process.height = ph;
          const context_process = canvas_process.getContext('2d');
          var w = ele.width;
          var h = ele.height;
          console.log("draw", w, h, pw, ph);
          context_process.drawImage(ele, 0, 0, w, h, 0, 0, pw, ph);
          var imageData = context_process.getImageData(0, 0, pw, ph);
          var greyImageData = [];
          for (let i = 0; i < imageData.data.length; i+=4) {
            greyImageData.push( Math.floor((imageData.data[i] + imageData.data[i+1] + imageData.data[i+2]) / 3));
          }

          console.log("data length: ", imageData.data.length, queryImage.data.length, greyImageData.length, greyQueryImage.data.length);
          for (let i = 0; i < imageData.data.length; i++) {
            if (imageData.data[i] != queryImage.data[i]) {
              console.log("INCORRECT color", i, imageData.data[i], queryImage.data[i]);
              break;
            }
          }
          for (let i = 0; i < greyImageData.length; i++) {
            if (greyImageData[i] !== greyQueryImage.data[i]) {
              console.log("INCORRECT grey", i, greyImageData[i], greyQueryImage.data[i]);
              break;
            }
          }

          var _start = new Date().getTime();
          //controller.process(queryImage);
          const result = controller.process({data: greyImageData, width: pw, height: ph});
          //const result = controller.process(greyQueryImage);
          console.log("result: ", result);
          var _end = new Date().getTime();
          console.log('exec time process Image: ', _start, _end, _end - _start);
        }
        process();
      });
    </script>
  </head>
  <body>
    <img id="target-image"/>
    <img id="test-image"/>
    <img id="test-image2" src="./assets/test.png"/>

    <br/>
    Canvas
    <canvas id="canvas"></canvas>
  </body>
</html>
